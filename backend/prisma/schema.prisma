// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Administrador {
  id              Int      @id @default(autoincrement())
  usuario         String   @unique @db.VarChar(50)
  password        String   @db.VarChar(255)
  nombre          String   @db.VarChar(100)
  email           String   @db.VarChar(100)
  whatsappNumero  String?  @map("whatsapp_numero") @db.VarChar(20)
  creadoEn        DateTime @default(now()) @map("creado_en")
  actualizadoEn   DateTime @updatedAt @map("actualizado_en")

  @@map("administradores")
}

model Empleado {
  id            Int       @id @default(autoincrement())
  nombre        String    @db.VarChar(100)
  cedula        String    @unique @db.VarChar(20)
  foto          String?   @db.VarChar(255)
  activo        Boolean   @default(true)
  creadoEn      DateTime  @default(now()) @map("creado_en")
  actualizadoEn DateTime  @updatedAt @map("actualizado_en")
  
  horarios      Horario[]
  bloqueos      Bloqueo[]
  citas         Cita[]
  ventas        Venta[]

  @@map("empleados")
}

model Servicio {
  id            Int      @id @default(autoincrement())
  nombre        String   @db.VarChar(100)
  descripcion   String?  @db.Text
  duracion      Int      @default(60)
  precio        Decimal  @db.Decimal(10, 2)
  activo        Boolean  @default(true)
  creadoEn      DateTime @default(now()) @map("creado_en")
  actualizadoEn DateTime @updatedAt @map("actualizado_en")
  
  citas         Cita[]
  ventas        Venta[]

  @@map("servicios")
}

enum DiaSemana {
  lunes
  martes
  miercoles
  jueves
  viernes
  sabado
  domingo
}

model Horario {
  id          Int       @id @default(autoincrement())
  empleadoId  Int       @map("empleado_id")
  diaSemana   DiaSemana @map("dia_semana")
  horaInicio  String    @default("10:00:00") @map("hora_inicio") @db.VarChar(8)
  horaFin     String    @default("18:00:00") @map("hora_fin") @db.VarChar(8)
  activo      Boolean   @default(true)
  
  empleado    Empleado  @relation(fields: [empleadoId], references: [id], onDelete: Cascade)

  @@unique([empleadoId, diaSemana], name: "unique_empleado_dia")
  @@map("horarios")
}

enum MotivoBloqueo {
  vacaciones
  dia_libre
  otro
}

model Bloqueo {
  id           Int            @id @default(autoincrement())
  empleadoId   Int            @map("empleado_id")
  fechaInicio  DateTime       @map("fecha_inicio") @db.Date
  fechaFin     DateTime       @map("fecha_fin") @db.Date
  motivo       MotivoBloqueo
  descripcion  String?        @db.Text
  creadoEn     DateTime       @default(now()) @map("creado_en")
  
  empleado     Empleado       @relation(fields: [empleadoId], references: [id], onDelete: Cascade)

  @@index([fechaInicio, fechaFin], name: "idx_bloqueos_fechas")
  @@map("bloqueos")
}

enum EstadoCita {
  pendiente
  confirmada
  cancelada
  completada
}

model Cita {
  id                        Int         @id @default(autoincrement())
  clienteNombre             String      @map("cliente_nombre") @db.VarChar(100)
  clienteEmail              String      @map("cliente_email") @db.VarChar(100)
  clienteTelefono           String      @map("cliente_telefono") @db.VarChar(20)
  servicioId                Int         @map("servicio_id")
  empleadoId                Int         @map("empleado_id")
  fecha                     DateTime    @db.Date
  hora                      String      @db.VarChar(8)
  estado                    EstadoCita  @default(pendiente)
  tokenConfirmacion         String?     @unique @map("token_confirmacion") @db.VarChar(64)
  motivoCancelacion         String?     @map("motivo_cancelacion") @db.Text
  recordatorioEnviado       Boolean     @default(false) @map("recordatorio_enviado")
  emailConfirmacionEnviado  Boolean     @default(false) @map("email_confirmacion_enviado")
  emailReciboEnviado        Boolean     @default(false) @map("email_recibo_enviado")
  creadoEn                  DateTime    @default(now()) @map("creado_en")
  actualizadoEn             DateTime    @updatedAt @map("actualizado_en")
  
  servicio                  Servicio    @relation(fields: [servicioId], references: [id])
  empleado                  Empleado    @relation(fields: [empleadoId], references: [id])
  venta                     Venta?

  @@unique([empleadoId, fecha, hora], name: "unique_cita")
  @@index([fecha], name: "idx_citas_fecha")
  @@index([estado], name: "idx_citas_estado")
  @@index([empleadoId], name: "idx_citas_empleado")
  @@map("citas")
}

model DiaFestivo {
  id          Int      @id @default(autoincrement())
  fecha       DateTime @unique @db.Date
  descripcion String   @db.VarChar(100)
  creadoEn    DateTime @default(now()) @map("creado_en")

  @@index([fecha], name: "idx_dias_festivos_fecha")
  @@map("dias_festivos")
}

model Venta {
  id         Int      @id @default(autoincrement())
  citaId     Int      @unique @map("cita_id")
  empleadoId Int      @map("empleado_id")
  servicioId Int      @map("servicio_id")
  fecha      DateTime @db.Date
  monto      Decimal  @db.Decimal(10, 2)
  creadoEn   DateTime @default(now()) @map("creado_en")
  
  cita       Cita     @relation(fields: [citaId], references: [id], onDelete: Cascade)
  empleado   Empleado @relation(fields: [empleadoId], references: [id])
  servicio   Servicio @relation(fields: [servicioId], references: [id])

  @@index([fecha], name: "idx_ventas_fecha")
  @@index([empleadoId], name: "idx_ventas_empleado")
  @@map("ventas")
}
